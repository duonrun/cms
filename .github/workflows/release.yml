name: Build & Release Panel

on:
  push:
    branches: [ "main" ]
    # Tag filters are glob patterns (not regex). Support stable + prerelease tags.
    # Examples: 0.1.0, 0.1.0-alpha.1, 0.1.0-beta.1, 0.1.0-rc.1
    tags:
      - "[0-9]*.[0-9]*.[0-9]*"
      - "[0-9]*.[0-9]*.[0-9]*-alpha.*"
      - "[0-9]*.[0-9]*.[0-9]*-beta.*"
      - "[0-9]*.[0-9]*.[0-9]*-rc.*"

  workflow_dispatch:
    inputs:
      tag:
        description: Tag to build/release (e.g. 0.1.0-beta.1)
        required: true
        type: string

permissions:
  contents: write  # required to create releases & upload assets

concurrency:
  group: panel-release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Determine release mode
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            MODE="versioned"
            RELEASE_TAG="${{ inputs.tag }}"
          elif [[ "${{ startsWith(github.ref, 'refs/tags/') }}" == "true" ]]; then
            MODE="versioned"
            RELEASE_TAG="${{ github.ref_name }}"
          else
            MODE="nightly"
            RELEASE_TAG=""
          fi

          if [[ "$MODE" == "versioned" ]]; then
            FILE_NAME="panel-${RELEASE_TAG}.tar.gz"
          else
            FILE_NAME="panel-nightly.tar.gz"
          fi

          if [[ "$RELEASE_TAG" == *"-alpha."* || "$RELEASE_TAG" == *"-beta."* || "$RELEASE_TAG" == *"-rc."* ]]; then
            IS_PRERELEASE="true"
          else
            IS_PRERELEASE="false"
          fi

          echo "MODE=$MODE" >> $GITHUB_ENV
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
          echo "FILE_NAME=$FILE_NAME" >> $GITHUB_ENV
          echo "IS_PRERELEASE=$IS_PRERELEASE" >> $GITHUB_ENV

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && format('refs/tags/{0}', inputs.tag) || github.ref }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install deps
        working-directory: ui
        run: bun install --frozen-lockfile

      - name: Build
        working-directory: ui
        run: bun run build

      - name: Ensure build output exists
        run: |
          if [ ! -d "ui/build" ]; then
            echo "Expected build output at ui/build not found."
            exit 1
          fi

      - name: Create tarball
        run: |
          mkdir -p dist
          cd ui/build && tar -czf "../../dist/${FILE_NAME}" * && cd ../..

      # Nightly prerelease (overwrite asset on every main push)
      - name: Upload to nightly prerelease
        if: github.ref == 'refs/heads/main' && env.MODE == 'nightly'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/${{ env.FILE_NAME }}
          asset_name: panel-nightly.tar.gz
          tag: nightly
          release_name: Nightly
          body: "Automated nightly panel build from main."
          prerelease: true
          overwrite: true

      # Versioned release for tags like 1.2.3 / 1.2.3-alpha.1 / 1.2.3-beta.1 / 1.2.3-rc.1
      - name: Upload to versioned release
        if: env.MODE == 'versioned'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/${{ env.FILE_NAME }}
          asset_name: ${{ env.FILE_NAME }}
          tag: ${{ env.RELEASE_TAG }}
          release_name: ${{ env.RELEASE_TAG }}
          body: "SvelteKit panel build for ${{ env.RELEASE_TAG }}."
          prerelease: ${{ env.IS_PRERELEASE }}
          overwrite: false
